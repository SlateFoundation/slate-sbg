Ext.define("Slate.sbg.widget.WorksheetPrompt",{extend:"Ext.container.Container",xtype:"sbg-worksheets-prompt",requires:["Ext.form.field.ComboBox"],config:{prompt:null,grade:null},layout:"hbox",items:[{xtype:"combobox",width:60,submitValue:false,store:"StandardsWorksheetPromptOptions",queryMode:"local",forceSelection:true,autoSelect:true,matchFieldWidth:false},{itemId:"promptCmp",flex:1,xtype:"component",tpl:"{Prompt}"}],initComponent:function(){var c=this,e,b,a,d;c.callParent(arguments);e=c.combo=c.down("combobox");b=c.promptCmp=c.down("#promptCmp");if(a=c.getPrompt()){b.update(a.getData())}e.setValue(d||null)},getGrade:function(){return this.combo?this.combo.getValue():this.callParent()},setGrade:function(b){var a=this.combo;if(a){a.setValue(b);a.resetOriginalValue()}}});Ext.define("Slate.sbg.overrides.NarrativesEditorForm",{override:"SlateAdmin.view.progress.narratives.EditorForm",requires:["Ext.form.FieldSet","Slate.sbg.widget.WorksheetPrompt"],initComponent:function(){var a=this;a.items=Ext.Array.insert(Ext.Array.clone(a.items),1,[{itemId:"sbgPromptsFieldset",xtype:"fieldset",title:"Standards-based grading worksheet",defaultType:"sbg-worksheets-prompt",hidden:true}]);a.callParent(arguments);a.sbgPromptsFieldset=a.down("#sbgPromptsFieldset")},getSbgGrades:function(){var e=this.sbgPromptsFieldset.items.getRange(),b=e.length,d=0,a,c={};for(;d<b;d++){a=e[d];c[a.getPrompt().getId()]=a.getGrade()}return c},setSbgGrades:function(c){var e=this.sbgPromptsFieldset.items.getRange(),b=e.length,d=0,a;c=c||{};for(;d<b;d++){a=e[d];if(a.isXType("sbg-worksheets-prompt")){a.setGrade(c[a.getPrompt().getId()])}}}});Ext.define("Slate.sbg.overrides.NarrativesReport",{override:"SlateAdmin.model.progress.narratives.Report"},function(a){a.addFields([{name:"SbgWorksheet"}])});Ext.define("Slate.sbg.overrides.NarrativesSectionsGrid",{override:"SlateAdmin.view.progress.narratives.SectionsGrid",requires:["Ext.grid.plugin.CellEditing","Ext.form.field.ComboBox"],width:300,worksheetColumnTitle:"Worksheet",emptyWorksheetText:"<em>Double-click to select</em>",initComponent:function(){var a=this;a.columns=a.columns.concat({text:a.worksheetColumnTitle,dataIndex:"WorksheetID",emptyCellText:a.emptyWorksheetText,width:200,editor:{xtype:"combo",allowBlank:true,emptyText:"Select worksheet",store:"StandardsWorksheets",displayField:"Title",valueField:"ID",queryMode:"local",triggerAction:"all",typeAhead:true,forceSelection:true,selectOnFocus:true},renderer:function(c,b,d){if(!c){return null}var e=d.get("worksheet");if(!e){return"[Deleted Worksheet]"}return e.get("Title")}});a.plugins=(a.plugins||[]).concat({ptype:"cellediting",clicksToEdit:2});a.callParent(arguments)}});Ext.define("Slate.sbg.model.StandardsWorksheet",{extend:"Ext.data.Model",requires:["Ext.data.validator.Presence","Ext.data.identifier.Negative"],idProperty:"ID",identifier:"negative",fields:[{name:"ID",type:"int",allowNull:true},{name:"Class",type:"string",defaultValue:"Slate\\SBG\\Worksheet"},{name:"Created",type:"date",dateFormat:"timestamp",allowNull:true},{name:"CreatorID",type:"int",allowNull:true},{name:"Title",type:"string"},{name:"Handle",type:"string"},{name:"Status",type:"string",defaultValue:"published"},{name:"Description",type:"string"}],validators:{Title:"presence"},proxy:{type:"slaterecords",url:"/sbg/worksheets",limitParam:null,startParam:null}});Ext.define("Slate.sbg.store.StandardsWorksheets",{extend:"Ext.data.Store",model:"Slate.sbg.model.StandardsWorksheet",pageSize:false,autoSync:false});Ext.define("Slate.sbg.model.StandardsWorksheetPrompt",{extend:"Ext.data.Model",requires:["Ext.data.identifier.Negative"],idProperty:"ID",identifier:"negative",fields:[{name:"ID",type:"int",allowNull:true},{name:"Class",type:"string",defaultValue:"Slate\\SBG\\WorksheetPrompt"},{name:"Created",type:"date",dateFormat:"timestamp",allowNull:true},{name:"CreatorID",type:"int",allowNull:true},{name:"WorksheetID",type:"int"},{name:"Position",type:"int",defaultValue:1},{name:"Prompt",type:"string"},{name:"Status",type:"string",defaultValue:"published"}],validators:{Prompt:"presence"},proxy:{type:"slaterecords",url:"/sbg/worksheet-prompts",limitParam:null,startParam:null}});Ext.define("Slate.sbg.store.StandardsWorksheetPrompts",{extend:"Ext.data.Store",model:"Slate.sbg.model.StandardsWorksheetPrompt",pageSize:false,autoSync:false,sorters:[{property:"Position"}]});Ext.define("Slate.sbg.view.worksheets.Grid",{extend:"Ext.grid.Panel",xtype:"sbg-worksheets-grid",requires:["Ext.grid.plugin.CellEditing","Ext.form.field.Text","Ext.grid.column.Action"],title:"Available Worksheets",componentCls:"sbg-worksheets-grid",bbar:[{flex:1,itemId:"createWorksheetBtn",xtype:"button",text:"Create Worksheet",glyph:61525}],hideHeaders:true,store:"StandardsWorksheets",columns:[{flex:1,text:"Title",dataIndex:"Title",emptyCellText:"Untitled worksheet"},{xtype:"actioncolumn",width:20,items:[{action:"delete",iconCls:"prompt-delete glyph-danger",glyph:61526,tooltip:"Delete prompt"}]}]});Ext.define("Slate.sbg.view.worksheets.PromptsGrid",{extend:"Ext.grid.Panel",xtype:"sbg-worksheets-promptsgrid",requires:["Ext.grid.plugin.CellEditing","Ext.form.field.Text","Ext.grid.column.Action"],title:"Prompts",componentCls:"sbg-worksheets-promptsgrid",plugins:[{ptype:"cellediting",pluginId:"cellediting",clicksToEdit:1}],hideHeaders:true,store:"StandardsWorksheetPrompts",columns:[{text:"Position",width:40,dataIndex:"Position"},{flex:1,text:"Prompt",dataIndex:"Prompt",editor:{xtype:"textfield",allowBlank:false,maxLength:255,enforceMaxLength:true}},{xtype:"actioncolumn",width:50,items:[{action:"up",glyph:61538,tooltip:"Move prompt up"},{action:"down",glyph:61539,tooltip:"Move prompt down"},{action:"delete",iconCls:"prompt-delete glyph-danger",glyph:61526,tooltip:"Delete prompt"}]}]});Ext.define("Slate.sbg.view.worksheets.Form",{extend:"Ext.form.Panel",xtype:"sbg-worksheets-form",requires:["Ext.form.field.Text","Ext.form.field.TextArea","Slate.sbg.view.worksheets.PromptsGrid"],disabled:true,title:"Selected Worksheet",componentCls:"sbg-standards-worksheets-editor",bodyPadding:10,scrollable:"vertical",trackResetOnLoad:true,defaults:{labelWidth:70,labelAlign:"right",anchor:"100%"},items:[{xtype:"textfield",name:"Title",fieldLabel:"Title",allowBlank:false},{xtype:"textareafield",name:"Description",fieldLabel:"Description",emptyText:"Optional explanation of worksheet for parents and students",grow:true},{xtype:"sbg-worksheets-promptsgrid"}],buttons:[{itemId:"revertBtn",text:"Revert Changes",cls:"glyph-danger",glyph:61527},{xtype:"tbfill"},{itemId:"addPromptBtn",text:"Add Prompt",glyph:61525},{itemId:"saveBtn",text:"Save Changes",cls:"glyph-success",glyph:61528}]});Ext.define("Slate.sbg.view.worksheets.Manager",{extend:"Ext.Container",xtype:"sbg-worksheets-manager",requires:["Slate.sbg.view.worksheets.Grid","Slate.sbg.view.worksheets.Form"],componentCls:"sbg-worksheets-manager",layout:"border",items:[{region:"west",split:true,xtype:"sbg-worksheets-grid",autoScroll:true,width:500},{region:"center",xtype:"sbg-worksheets-form",flex:1}]});Ext.define("Slate.sbg.controller.Worksheets",{extend:"Ext.app.Controller",routes:{"settings/standards-worksheets":"showWorksheetSettings"},views:["worksheets.Manager@Slate.sbg.view"],stores:["StandardsWorksheets@Slate.sbg.store","StandardsWorksheetPrompts@Slate.sbg.store"],refs:{settingsNavPanel:"settings-navpanel",managerCt:{selector:"sbg-worksheets-manager",autoCreate:true,xtype:"sbg-worksheets-manager"},grid:"sbg-worksheets-grid",form:"sbg-worksheets-form",titleField:"sbg-worksheets-form field[name=Title]",promptsGrid:"sbg-worksheets-promptsgrid",revertBtn:"sbg-worksheets-form button#revertBtn",saveBtn:"sbg-worksheets-form button#saveBtn"},control:{managerCt:{activate:"onManagerCtActivate"},"sbg-worksheets-manager button#createWorksheetBtn":{click:"onCreateWorksheetBtnClick"},grid:{beforeselect:"onGridBeforeSelect",select:"onGridSelect",deleteclick:"onWorksheetDeleteClick"},"sbg-worksheets-form field":{dirtychange:"onFieldDirtyChange"},promptsGrid:{upclick:"onPromptGridUpClick",downclick:"onPromptGridDownClick",deleteclick:"onPromptDeleteClick"},revertBtn:{click:"onRevertBtnClick"},saveBtn:{click:"onSaveBtnClick"},"sbg-worksheets-manager button#addPromptBtn":{click:"onAddPromptBtnClick"}},listen:{store:{"#StandardsWorksheets":{update:"onWorksheetUpdate"},"#StandardsWorksheetPrompts":{add:"onWorksheetPromptAdd",update:"onWorksheetPromptUpdate",remove:"onWorksheetPromptRemove",write:"onWorksheetPromptsStoreWrite"}}},init:function(){SlateAdmin.view.settings.NavPanel.prototype.config.data.push({href:"#settings/standards-worksheets",text:"Standards Worksheets"})},onLaunch:function(){console.warn("SBG controller launched")},showWorksheetSettings:function(){var b=this,a=b.getSettingsNavPanel();Ext.suspendLayouts();Ext.util.History.suspendState();a.setActiveLink("settings/standards-worksheets");a.expand(false);Ext.util.History.resumeState(false);b.application.getController("Viewport").loadCard(b.getManagerCt());Ext.resumeLayouts(true)},onManagerCtActivate:function(){this.getStandardsWorksheetsStore().load()},onCreateWorksheetBtnClick:function(){var a=this.getGrid(),b=a.getStore().add({})[0];a.setSelection(b);this.getTitleField().focus()},onGridBeforeSelect:function(a,e){var c=this,b=c.getForm(),d=b.getRecord();if(d&&(b.isDirty()||c.isPromptsStoreDirty())){Ext.Msg.confirm("Unsaved Changes","You have unsaved changes to this worksheet.<br/><br/>Do you want to continue without saving them?",function(f){if(f!="yes"){return}c.revertChanges();a.select([e])});return false}},onGridSelect:function(a,e){var d=this,c=d.getForm(),b=d.getStandardsWorksheetPromptsStore();c.enable();c.loadRecord(e);if(e.phantom){b.loadRecords([])}else{b.load({params:{worksheet:e.getId()}})}d.syncFormButtons()},onWorksheetDeleteClick:function(a,b){Ext.Msg.confirm("Delete Worksheet",Ext.String.format('Are you sure you want to delete the worksheet <strong>"{0}"</strong> and all of its prompts?',b.get("Title")),function(c){if(c!="yes"){return}b.erase()})},onFieldDirtyChange:function(b,a){this.syncFormButtons()},onPromptGridUpClick:function(f,a,c,e){var b=f.getStore(),d=b.getAt(e-1);if(!d){return}b.beginUpdate();d.set("Position",e+1);a.set("Position",e);b.endUpdate()},onPromptGridDownClick:function(f,a,d,e){var b=f.getStore(),c=b.getAt(e+1);if(!c){return}b.beginUpdate();a.set("Position",e+2);c.set("Position",e+1);b.endUpdate()},onPromptDeleteClick:function(e,a,c,d){var b=e.getStore();b.remove(a);b.each(function(g,f){if(f>=d){g.set("Position",f+1)}})},onWorksheetUpdate:function(a,d,b){var c=this.getForm();if(b=="commit"&&c.getRecord()===d){c.loadRecord(d)}},onWorksheetPromptAdd:function(){this.syncFormButtons()},onWorksheetPromptUpdate:function(){this.syncFormButtons()},onWorksheetPromptRemove:function(){this.syncFormButtons()},onWorksheetPromptsStoreWrite:function(){this.syncFormButtons()},onRevertBtnClick:function(){var c=this,a=c.getGrid(),b=c.getForm(),d=b.getRecord();Ext.Msg.confirm("Discard Changes","Are you sure you want to discard all changes to this worksheet?",function(e){if(e!="yes"){return}c.revertChanges();if(d.phantom){b.disable();a.getStore().remove(d)}})},onSaveBtnClick:function(){var f=this,c=f.getManagerCt(),e=f.getForm(),g=e.getRecord(),a=g.phantom,d=f.getStandardsWorksheetPromptsStore(),b=function(){var h=g.getId();if(a){d.each(function(i){i.set("WorksheetID",h)})}d.sync({callback:function(j,i){c.setLoading(false)}})};e.updateRecord(g);if(!g.dirty&&!f.isPromptsStoreDirty()){return}c.setLoading("Saving worksheet&hellip;");if(g.dirty){g.save({callback:function(h,i,j){if(j){b()}else{c.setLoading(false);Ext.Msg.alert("Failed to save worksheet","This worksheet failed to save to the server:<br><br>"+(i.getError()||"Unknown reason, try again or contact support"))}}})}else{b()}},onAddPromptBtnClick:function(){var c=this.getPromptsGrid(),b=c.getStore(),a=b.add({WorksheetID:this.getForm().getRecord().getId(),Position:b.getCount()+1})[0];c.getPlugin("cellediting").startEdit(a,1)},syncFormButtons:function(){var d=this,c=d.getForm(),a=c.isDirty(),b=d.isPromptsStoreDirty();d.getRevertBtn().setDisabled(!a&&!c.getRecord().phantom&&!b);d.getSaveBtn().setDisabled((!a&&!b)||!c.isValid()||!d.isPromptsStoreValid())},revertChanges:function(){this.getForm().reset();this.getStandardsWorksheetPromptsStore().rejectChanges()},isPromptsStoreValid:function(){var a=true;this.getStandardsWorksheetPromptsStore().each(function(b){if(!b.isValid()){a=false;return false}});return a},isPromptsStoreDirty:function(){var a=this.getStandardsWorksheetPromptsStore();return(a.getNewRecords().length||a.getUpdatedRecords().length||a.getRemovedRecords().length)}});Ext.define("Slate.sbg.model.StandardsWorksheetAssignment",{extend:"Ext.data.Model",requires:["Ext.data.identifier.Negative"],idProperty:"ID",identifier:"negative",fields:[{name:"ID",type:"int",allowNull:true},{name:"Class",type:"string",defaultValue:"Slate\\SBG\\WorksheetAssignment"},{name:"Created",type:"date",dateFormat:"timestamp",allowNull:true},{name:"CreatorID",type:"int",allowNull:true},{name:"TermID",type:"int"},{name:"CourseSectionID",type:"int"},{name:"WorksheetID",type:"int",allowNull:true}],proxy:{type:"slaterecords",url:"/sbg/worksheet-assignments",limitParam:null,startParam:null}});Ext.define("Slate.sbg.store.StandardsWorksheetAssignments",{extend:"Ext.data.Store",model:"Slate.sbg.model.StandardsWorksheetAssignment",pageSize:false,autoSync:false});Ext.define("Slate.sbg.store.StandardsWorksheetPromptOptions",{extend:"Ext.data.Store",config:{fields:["id","text"],data:[{id:0,text:"N/A"},{id:1,text:"1"},{id:2,text:"2"},{id:3,text:"3"},{id:4,text:"4"}]}});Ext.define("Slate.sbg.controller.Narratives",{extend:"Ext.app.Controller",config:{worksheet:null},stores:["StandardsWorksheets@Slate.sbg.store","StandardsWorksheetAssignments@Slate.sbg.store","StandardsWorksheetPrompts@Slate.sbg.store","StandardsWorksheetPromptOptions@Slate.sbg.store"],views:["WorksheetPrompt@Slate.sbg.widget"],refs:{sectionsGrid:"progress-narratives-sectionsgrid",termSelector:"progress-narratives-sectionsgrid #termSelector",editorForm:"progress-narratives-editorform",promptsFieldset:"progress-narratives-editorform #sbgPromptsFieldset"},control:{sectionsGrid:{boxready:"onSectionsGridBoxReady",select:"onSectionsGridSelect"}},listen:{store:{"#progress.narratives.Sections":{load:"onSectionsLoad",update:"onSectionUpdate"}},controller:{"#progress.Narratives":{reportload:"onReportLoad",beforereportsave:"onBeforeReportSave",reportsave:"onReportSave"}}},updateWorksheet:function(b){var c=this,d=c.getPromptsFieldset(),a=c.getStandardsWorksheetPromptsStore();d.hide();if(b){a.getProxy().setExtraParam("worksheet",b);a.load({callback:function(g){var f=g.length,h=0,e,j=[];for(;h<f;h++){e=g[h];j.push({prompt:e})}if(!j.length){j.push({xtype:"component",html:"Selected worksheet contains no prompts"})}Ext.suspendLayouts();d.removeAll();d.add(j);d.show();Ext.resumeLayouts(true)}})}else{a.loadRecords([])}},onSectionsGridBoxReady:function(b){var a=this.getStandardsWorksheetsStore();this.setWorksheet(null);if(!a.isLoaded()){a.load()}},onSectionsGridSelect:function(b,a){this.setWorksheet(a.get("WorksheetID"))},onSectionsLoad:function(b){var d=this,c=d.getSectionsGrid().getView(),a=d.getStandardsWorksheetsStore(),f=d.getStandardsWorksheetAssignmentsStore(),e=function(){var h=f.getRange(),g=h.length,k=0,m,j,l;b.beginUpdate();for(;k<g;k++){m=h[k];j=m.get("WorksheetID");if(l=b.getById(m.get("CourseSectionID"))){l.set({WorksheetID:j,worksheet:a.getById(j),worksheetAssignment:m},{dirty:false})}}b.endUpdate();c.setLoading(false);c.loadMask.msg=c.loadingText};f.getProxy().setExtraParams(b.getProxy().getExtraParams());c.setLoading("Loading SBG assignments&hellip;");f.load({callback:function(){if(a.isLoading()){a.on("load",e,d,{single:true})}else{e()}}})},onSectionUpdate:function(a,f,b,e){if(b!="edit"||e.indexOf("WorksheetID")==-1){return}var d=this,g=f.get("worksheetAssignment"),c=f.get("WorksheetID");if(g){g.set("WorksheetID",c)}else{g=d.getStandardsWorksheetAssignmentsStore().add({TermID:d.getTermSelector().getSelection().getId(),CourseSectionID:f.getId(),WorksheetID:c})[0]}if(!g.dirty){return}g.save({success:function(){f.set({WorksheetID:c,worksheetAssignment:g},{dirty:false});f.commit();d.setWorksheet(c)}})},onReportLoad:function(a){var b=a.get("SbgWorksheet");this.getEditorForm().setSbgGrades(b&&b.worksheet_id==this.getWorksheet()&&b.grades)},onBeforeReportSave:function(a){a.set("SbgWorksheet",{worksheet_id:this.getWorksheet(),grades:this.getEditorForm().getSbgGrades()})},onReportSave:function(a){var b=a.get("SbgWorksheet");this.getEditorForm().setSbgGrades(b&&b.worksheet_id==this.getWorksheet()&&b.grades)}});Ext.define("Slate.sbg.overrides.SlateAdmin",{override:"SlateAdmin.Application",requires:["Slate.sbg.controller.Worksheets","Slate.sbg.controller.Narratives"],initControllers:function(){this.callParent();this.getController("Slate.sbg.controller.Worksheets");this.getController("Slate.sbg.controller.Narratives")}});