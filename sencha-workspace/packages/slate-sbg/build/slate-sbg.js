Ext.define('Slate.sbg.overrides.SectionTermReport',{override:'Slate.model.progress.SectionTermReport'},function(a){a.addFields([{name:'SbgWorksheet',convert:function(b){return typeof b=='string'?Ext.decode(b,!0)||null:b}}])});Ext.define('Slate.sbg.store.StandardsWorksheetPromptOptions',{extend:'Ext.data.Store',config:{fields:['id','text'],data:[{id:0,text:'N/A'},{id:1,text:'1'},{id:2,text:'2'},{id:3,text:'3'},{id:4,text:'4'}]}});Ext.define('Slate.sbg.widget.WorksheetPrompt',{extend:'Ext.container.Container',xtype:'sbg-worksheets-prompt',requires:['Ext.form.field.ComboBox'],config:{prompt:null,grade:null},layout:'hbox',items:[{xtype:'combobox',width:60,submitValue:!1,store:{xclass:'Slate.sbg.store.StandardsWorksheetPromptOptions'},valueField:'id',displayField:'text',queryMode:'local',forceSelection:!0,autoSelect:!0,matchFieldWidth:!1},{itemId:'promptCmp',flex:1,xtype:'component',tpl:'{Prompt}'}],initComponent:function(){var a=this,d,b,c,e;a.callParent(arguments);d=a.combo=a.down('combobox');b=a.promptCmp=a.down('#promptCmp');if(c=a.getPrompt()){b.update(c.getData())}d.setValue(e||null)},getGrade:function(){return this.combo?this.combo.getValue():this.callParent()},setGrade:function(b){var a=this.combo;if(a){a.setValue(b);a.resetOriginalValue()}}});Ext.define('Slate.sbg.overrides.SectionTermReportEditorForm',{override:'SlateAdmin.view.progress.terms.EditorForm',requires:['Ext.form.FieldSet','Slate.sbg.widget.WorksheetPrompt'],initComponent:function(){var a=this;a.items=Ext.Array.insert(Ext.Array.clone(a.items),1,[{itemId:'sbgPromptsFieldset',xtype:'fieldset',title:'Standards-based grading worksheet',defaultType:'sbg-worksheets-prompt',hidden:!0}]);a.callParent(arguments);a.sbgPromptsFieldset=a.down('#sbgPromptsFieldset')},getSbgGrades:function(){var c=this.sbgPromptsFieldset.items.getRange(),e=c.length,b=0,a,d={};for(;b<e;b++){a=c[b];if(a.isXType('sbg-worksheets-prompt')){d[a.getPrompt().getId()]=a.getGrade()}}return d},setSbgGrades:function(b){var d=this.sbgPromptsFieldset.items.getRange(),e=d.length,c=0,a;b=b||{};for(;c<e;c++){a=d[c];if(a.isXType('sbg-worksheets-prompt')){a.setGrade(b[a.getPrompt().getId()])}}}});Ext.define('Slate.sbg.model.StandardsWorksheet',{extend:'Ext.data.Model',requires:['Slate.proxy.Records','Ext.data.validator.Presence','Ext.data.identifier.Negative'],idProperty:'ID',identifier:'negative',fields:[{name:'ID',type:'int',allowNull:!0},{name:'Class',type:'string',defaultValue:'Slate\\SBG\\Worksheet'},{name:'Created',type:'date',dateFormat:'timestamp',allowNull:!0},{name:'CreatorID',type:'int',allowNull:!0},{name:'Title',type:'string'},{name:'Handle',type:'string'},{name:'Status',type:'string',defaultValue:'published'},{name:'Description',type:'string'}],validators:{Title:'presence'},proxy:{type:'slate-records',url:'/sbg/worksheets',limitParam:null,startParam:null}});Ext.define('Slate.sbg.store.StandardsWorksheets',{extend:'Ext.data.Store',model:'Slate.sbg.model.StandardsWorksheet',config:{pageSize:!1,autoSync:!1}});Ext.define('Slate.sbg.model.StandardsWorksheetPrompt',{extend:'Ext.data.Model',requires:['Slate.proxy.Records','Ext.data.identifier.Negative'],idProperty:'ID',identifier:'negative',fields:[{name:'ID',type:'int',allowNull:!0},{name:'Class',type:'string',defaultValue:'Slate\\SBG\\WorksheetPrompt'},{name:'Created',type:'date',dateFormat:'timestamp',allowNull:!0},{name:'CreatorID',type:'int',allowNull:!0},{name:'WorksheetID',type:'int'},{name:'Position',type:'int',defaultValue:1},{name:'Prompt',type:'string'},{name:'Status',type:'string',defaultValue:'published'}],validators:{Prompt:'presence'},proxy:{type:'slate-records',url:'/sbg/worksheet-prompts',limitParam:null,startParam:null}});Ext.define('Slate.sbg.store.StandardsWorksheetPrompts',{extend:'Ext.data.Store',model:'Slate.sbg.model.StandardsWorksheetPrompt',config:{pageSize:!1,autoSync:!1,sorters:[{property:'Position'}]}});Ext.define('Slate.sbg.view.worksheets.Grid',{extend:'Ext.grid.Panel',xtype:'sbg-worksheets-grid',requires:['Ext.grid.plugin.CellEditing','Ext.form.field.Text','Ext.grid.column.Action'],title:'Available Worksheets',componentCls:'sbg-worksheets-grid',bbar:[{flex:1,itemId:'createWorksheetBtn',xtype:'button',text:'Create Worksheet',glyph:61525}],hideHeaders:!0,store:'StandardsWorksheets',columns:[{flex:1,text:'Title',dataIndex:'Title',emptyCellText:'Untitled worksheet'},{xtype:'actioncolumn',width:20,items:[{action:'delete',iconCls:'prompt-delete glyph-danger',glyph:61526,tooltip:'Delete prompt'}]}]});Ext.define('Slate.sbg.view.worksheets.PromptsGrid',{extend:'Ext.grid.Panel',xtype:'sbg-worksheets-promptsgrid',requires:['Ext.grid.plugin.CellEditing','Ext.form.field.TextArea','Ext.grid.column.Action'],title:'Prompts',componentCls:'sbg-worksheets-promptsgrid',plugins:[{ptype:'cellediting',pluginId:'cellediting',clicksToEdit:1}],hideHeaders:!0,store:'StandardsWorksheetPrompts',columns:[{text:'Position',width:40,dataIndex:'Position'},{flex:1,text:'Prompt',dataIndex:'Prompt',editor:{xtype:'textarea',allowBlank:!1,maxLength:500,enforceMaxLength:!0,enterIsSpecial:!0}},{xtype:'actioncolumn',width:50,items:[{action:'up',glyph:61538,tooltip:'Move prompt up'},{action:'down',glyph:61539,tooltip:'Move prompt down'},{action:'delete',iconCls:'prompt-delete glyph-danger',glyph:61526,tooltip:'Delete prompt'}]}]});Ext.define('Slate.sbg.view.worksheets.Form',{extend:'Ext.form.Panel',xtype:'sbg-worksheets-form',requires:['Ext.form.field.Text','Ext.form.field.TextArea','Slate.sbg.view.worksheets.PromptsGrid'],disabled:!0,title:'Selected Worksheet',componentCls:'sbg-standards-worksheets-editor',bodyPadding:10,scrollable:'vertical',trackResetOnLoad:!0,defaults:{labelWidth:70,labelAlign:'right',anchor:'100%'},items:[{xtype:'textfield',name:'Title',fieldLabel:'Title',allowBlank:!1},{xtype:'textareafield',name:'Description',fieldLabel:'Description',emptyText:'Optional explanation of worksheet for parents and students',grow:!0},{xtype:'sbg-worksheets-promptsgrid'}],buttons:[{itemId:'revertBtn',text:'Revert Changes',cls:'glyph-danger',glyph:61527},{xtype:'tbfill'},{itemId:'addPromptBtn',text:'Add Prompt',glyph:61525},{itemId:'saveBtn',text:'Save Changes',cls:'glyph-success',glyph:61528}]});Ext.define('Slate.sbg.view.worksheets.Manager',{extend:'Ext.Container',xtype:'sbg-worksheets-manager',requires:['Slate.sbg.view.worksheets.Grid','Slate.sbg.view.worksheets.Form'],componentCls:'sbg-worksheets-manager',layout:'border',items:[{region:'west',split:!0,xtype:'sbg-worksheets-grid',autoScroll:!0,width:500},{region:'center',xtype:'sbg-worksheets-form',flex:1}]});Ext.define('Slate.sbg.controller.Worksheets',{extend:'Ext.app.Controller',routes:{'settings/standards-worksheets':'showWorksheetSettings'},views:['worksheets.Manager@Slate.sbg.view'],stores:['StandardsWorksheets@Slate.sbg.store','StandardsWorksheetPrompts@Slate.sbg.store'],refs:{settingsNavPanel:'settings-navpanel',managerCt:{selector:'sbg-worksheets-manager',autoCreate:!0,xtype:'sbg-worksheets-manager'},grid:'sbg-worksheets-grid',form:'sbg-worksheets-form',titleField:'sbg-worksheets-form field[name=Title]',promptsGrid:'sbg-worksheets-promptsgrid',revertBtn:'sbg-worksheets-form button#revertBtn',saveBtn:'sbg-worksheets-form button#saveBtn'},control:{managerCt:{activate:'onManagerCtActivate'},'sbg-worksheets-manager button#createWorksheetBtn':{click:'onCreateWorksheetBtnClick'},grid:{beforeselect:'onGridBeforeSelect',select:'onGridSelect',deleteclick:'onWorksheetDeleteClick'},'sbg-worksheets-form field':{dirtychange:'onFieldDirtyChange'},promptsGrid:{upclick:'onPromptGridUpClick',downclick:'onPromptGridDownClick',deleteclick:'onPromptDeleteClick'},revertBtn:{click:'onRevertBtnClick'},saveBtn:{click:'onSaveBtnClick'},'sbg-worksheets-manager button#addPromptBtn':{click:'onAddPromptBtnClick'}},listen:{store:{'#StandardsWorksheets':{update:'onWorksheetUpdate'},'#StandardsWorksheetPrompts':{add:'onWorksheetPromptAdd',update:'onWorksheetPromptUpdate',remove:'onWorksheetPromptRemove',write:'onWorksheetPromptsStoreWrite'}}},init:function(){SlateAdmin.view.settings.NavPanel.prototype.config.data.push({href:'#settings/standards-worksheets',text:'Standards Worksheets'})},onLaunch:function(){console.warn('SBG controller launched')},showWorksheetSettings:function(){var a=this,b=a.getSettingsNavPanel();Ext.suspendLayouts();Ext.util.History.suspendState();b.setActiveLink('settings/standards-worksheets');b.expand(!1);Ext.util.History.resumeState(!1);a.application.getController('Viewport').loadCard(a.getManagerCt());Ext.resumeLayouts(!0)},onManagerCtActivate:function(){this.getStandardsWorksheetsStore().load()},onCreateWorksheetBtnClick:function(){var a=this.getGrid(),b=a.getStore().add({})[0];a.setSelection(b);this.getTitleField().focus()},onGridBeforeSelect:function(e,d){var a=this,b=a.getForm(),c=b.getRecord();if(c&&(b.isDirty()||a.isPromptsStoreDirty())){Ext.Msg.confirm('Unsaved Changes','You have unsaved changes to this worksheet.<br/><br/>Do you want to continue without saving them?',function(b){if(b!='yes'){return}a.revertChanges();e.select([d])});return !1}},onGridSelect:function(e,a){var b=this,d=b.getForm(),c=b.getStandardsWorksheetPromptsStore();d.enable();d.loadRecord(a);if(a.phantom){c.loadRecords([])}else {c.load({params:{worksheet:a.getId()}})}b.syncFormButtons()},onWorksheetDeleteClick:function(b,a){Ext.Msg.confirm('Delete Worksheet',Ext.String.format('Are you sure you want to delete the worksheet <strong>"{0}"</strong> and all of its prompts?',a.get('Title')),function(c){if(c!='yes'){return}a.erase()})},onFieldDirtyChange:function(b,a){this.syncFormButtons()},onPromptGridUpClick:function(d,e,f,b){var a=d.getStore(),c=a.getAt(b-1);if(!c){return}a.beginUpdate();c.set('Position',b+1);e.set('Position',b);a.endUpdate()},onPromptGridDownClick:function(d,e,f,b){var a=d.getStore(),c=a.getAt(b+1);if(!c){return}a.beginUpdate();e.set('Position',b+2);c.set('Position',b+1);a.endUpdate()},onPromptDeleteClick:function(b,d,e,c){var a=b.getStore();a.remove(d);a.each(function(f,a){if(a>=c){f.set('Position',a+1)}})},onWorksheetUpdate:function(d,a,c){var b=this.getForm();if(c=='commit'&&b.getRecord()===a){b.loadRecord(a)}},onWorksheetPromptAdd:function(){this.syncFormButtons()},onWorksheetPromptUpdate:function(){this.syncFormButtons()},onWorksheetPromptRemove:function(){this.syncFormButtons()},onWorksheetPromptsStoreWrite:function(){this.syncFormButtons()},onRevertBtnClick:function(){var a=this,d=a.getGrid(),c=a.getForm(),b=c.getRecord();Ext.Msg.confirm('Discard Changes','Are you sure you want to discard all changes to this worksheet?',function(e){if(e!='yes'){return}a.revertChanges();if(b.phantom){c.disable();d.getStore().remove(b)}})},onSaveBtnClick:function(){var c=this,b=c.getManagerCt(),g=c.getForm(),a=g.getRecord(),h=a.phantom,f=c.getStandardsWorksheetPromptsStore(),d=c.isPromptsStoreDirty(),e=function(){var c=a.getId();if(h){f.each(function(a){a.set('WorksheetID',c)})}if(d){f.sync({callback:function(c,a){b.setLoading(!1)}})}else {b.setLoading(!1)}};g.updateRecord(a);if(!a.dirty&&!d){return}b.setLoading('Saving worksheet&hellip;');if(a.dirty){a.save({callback:function(d,a,c){if(c){e()}else {b.setLoading(!1);Ext.Msg.alert('Failed to save worksheet','This worksheet failed to save to the server:<br><br>'+(a.getError()||'Unknown reason, try again or contact support'))}}})}else {e()}},onAddPromptBtnClick:function(){var b=this.getPromptsGrid(),a=b.getStore(),c=a.add({WorksheetID:this.getForm().getRecord().getId(),Position:a.getCount()+1})[0];b.getPlugin('cellediting').startEdit(c,1)},syncFormButtons:function(){var a=this,b=a.getForm(),d=b.isDirty(),c=a.isPromptsStoreDirty();a.getRevertBtn().setDisabled(!d&&!b.getRecord().phantom&&!c);a.getSaveBtn().setDisabled(!d&&!c||!b.isValid()||!a.isPromptsStoreValid())},revertChanges:function(){this.getForm().reset();this.getStandardsWorksheetPromptsStore().rejectChanges()},isPromptsStoreValid:function(){var a=!0;this.getStandardsWorksheetPromptsStore().each(function(b){if(!b.isValid()){a=!1;return !1}});return a},isPromptsStoreDirty:function(){var a=this.getStandardsWorksheetPromptsStore();return a.getNewRecords().length||a.getUpdatedRecords().length||a.getRemovedRecords().length}});Ext.define('Slate.sbg.model.StandardsWorksheetAssignment',{extend:'Ext.data.Model',requires:['Slate.proxy.Records','Ext.data.identifier.Negative'],idProperty:'ID',identifier:'negative',fields:[{name:'ID',type:'int',allowNull:!0},{name:'Class',type:'string',defaultValue:'Slate\\SBG\\WorksheetAssignment'},{name:'Created',type:'date',dateFormat:'timestamp',allowNull:!0},{name:'CreatorID',type:'int',allowNull:!0},{name:'TermID',type:'int'},{name:'CourseSectionID',type:'int'},{name:'WorksheetID',type:'int',allowNull:!0}],proxy:{type:'slate-records',url:'/sbg/worksheet-assignments',limitParam:null,startParam:null}});Ext.define('Slate.sbg.store.StandardsWorksheetAssignments',{extend:'Ext.data.Store',model:'Slate.sbg.model.StandardsWorksheetAssignment',config:{pageSize:!1,autoSync:!1}});Ext.define('Slate.sbg.controller.SectionTermReports',{extend:'Ext.app.Controller',config:{worksheet:null},stores:['StandardsWorksheets@Slate.sbg.store','StandardsWorksheetAssignments@Slate.sbg.store','StandardsWorksheetPrompts@Slate.sbg.store','StandardsWorksheetPromptOptions@Slate.sbg.store'],views:['WorksheetPrompt@Slate.sbg.widget'],refs:{sectionsGrid:'progress-terms-sectionsgrid',termSelector:'progress-terms-sectionsgrid #termSelector',editorForm:'progress-terms-editorform',promptsFieldset:'progress-terms-editorform #sbgPromptsFieldset'},control:{sectionsGrid:{boxready:'onSectionsGridBoxReady',select:'onSectionsGridSelect'}},listen:{store:{'#progress.terms.Sections':{load:'onSectionsLoad',update:'onSectionUpdate'}},controller:{'#progress.terms.Report':{reportload:'onReportLoad',beforereportsave:'onBeforeReportSave',reportsave:'onReportSave'}}},updateWorksheet:function(c){var d=this,a=d.getPromptsFieldset(),b=d.getStandardsWorksheetPromptsStore();a.hide();if(c){b.getProxy().setExtraParam('worksheet',c);b.load({callback:function(e){var g=e.length,d=0,f,b=[];for(;d<g;d++){f=e[d];b.push({prompt:f})}if(!b.length){b.push({xtype:'component',html:'Selected worksheet contains no prompts'})}Ext.suspendLayouts();a.removeAll();a.add(b);a.show();Ext.resumeLayouts(!0)}})}else {b.loadRecords([])}},onSectionsGridBoxReady:function(b){var a=this.getStandardsWorksheetsStore();this.setWorksheet(null);if(!a.isLoaded()){a.load()}},onSectionsGridSelect:function(b,a){this.setWorksheet(a.get('WorksheetID'))},onSectionsLoad:function(a){var c=this,b=c.getSectionsGrid().getView(),e=c.getStandardsWorksheetsStore(),d=c.getStandardsWorksheetAssignmentsStore(),f=function(){var h=d.getRange(),j=h.length,g=0,c,f,i;a.beginUpdate();for(;g<j;g++){c=h[g];f=c.get('WorksheetID');if(i=a.getById(c.get('CourseSectionID'))){i.set({WorksheetID:f,worksheet:e.getById(f),worksheetAssignment:c},{dirty:!1})}}a.endUpdate();b.setLoading(!1);b.loadMask.msg=b.loadingText};d.getProxy().setExtraParams(a.getProxy().getExtraParams());b.setLoading('Loading SBG assignments&hellip;');d.load({callback:function(){if(e.isLoading()){e.on('load',f,c,{single:!0})}else {f()}}})},onSectionUpdate:function(g,c,f,e){if(f!='edit'||e.indexOf('WorksheetID')==-1){return}var d=this,a=c.get('worksheetAssignment'),b=c.get('WorksheetID');if(a){a.set('WorksheetID',b)}else {a=d.getStandardsWorksheetAssignmentsStore().add({TermID:d.getTermSelector().getSelection().getId(),CourseSectionID:c.getId(),WorksheetID:b})[0]}if(!a.dirty&&!a.phantom){return}a.save({success:function(){c.set({WorksheetID:b,worksheet:d.getStandardsWorksheetsStore().getById(b),worksheetAssignment:a},{dirty:!1});c.commit();d.setWorksheet(b)}})},onReportLoad:function(b){var a=b.get('SbgWorksheet');this.getEditorForm().setSbgGrades(a&&a.worksheet_id==this.getWorksheet()&&a.grades)},onBeforeReportSave:function(a){a.set('SbgWorksheet',{worksheet_id:this.getWorksheet(),grades:this.getEditorForm().getSbgGrades()})},onReportSave:function(b){var a=b.get('SbgWorksheet');this.getEditorForm().setSbgGrades(a&&a.worksheet_id==this.getWorksheet()&&a.grades)}});Ext.define('Slate.sbg.overrides.SlateAdmin',{override:'SlateAdmin.Application',requires:['Slate.sbg.controller.Worksheets','Slate.sbg.controller.SectionTermReports'],initControllers:function(){this.callParent();this.getController('Slate.sbg.controller.Worksheets');this.getController('Slate.sbg.controller.SectionTermReports')}});Ext.define('Slate.sbg.overrides.TermReportPrintContainer',{override:'SlateAdmin.view.progress.terms.print.Container',config:{standardsWorksheetTitle:'Standards Worksheet'},initComponent:function(){var a=this;a.callParent(arguments);a.down('fieldset#includeFieldset').add({boxLabel:a.getStandardsWorksheetTitle(),name:'print[sbg_worksheet]',checked:!0})}});Ext.define('Slate.sbg.overrides.TermReportSectionsGrid',{override:'SlateAdmin.view.progress.terms.SectionsGrid',requires:['Ext.grid.plugin.CellEditing','Ext.form.field.ComboBox'],width:300,worksheetColumnTitle:'Worksheet',emptyWorksheetText:'<em>Double-click to select</em>',initComponent:function(){var a=this;a.columns=a.columns.concat({flex:1,text:a.worksheetColumnTitle,dataIndex:'WorksheetID',emptyCellText:a.emptyWorksheetText,editor:{xtype:'combo',allowBlank:!0,emptyText:'Select worksheet',matchFieldWidth:!1,store:'StandardsWorksheets',displayField:'Title',valueField:'ID',queryMode:'local',triggerAction:'all',typeAhead:!0,forceSelection:!0,selectOnFocus:!0},renderer:function(b,d,c){if(!b){return null}var a=c.get('worksheet');if(!a){return '[Deleted Worksheet]'}return a.get('Title')}});a.plugins=(a.plugins||[]).concat({ptype:'cellediting',clicksToEdit:2});a.callParent(arguments)}});